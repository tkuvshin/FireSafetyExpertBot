import os
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, ContextTypes, filters
from openai import OpenAI
from fastapi import FastAPI
import uvicorn

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI
client_gpt = OpenAI(api_key=os.environ["MyKey2"])

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = ServiceAccountCredentials.from_json_keyfile_name("credentials.json", scope)
client_gs = gspread.authorize(creds)

SPREADSHEET_ID = os.environ["sheets_id"]
sheet = client_gs.open_by_key(SPREADSHEET_ID).sheet1

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
records = sheet.get_all_records()

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_message = update.message.text.strip()
    print(f"\n–ü–û–õ–£–ß–ï–ù –í–û–ü–†–û–°: {user_message}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    for record in records:
        if record["question"].strip().lower() == user_message.strip().lower():
            print("‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –±–∞–∑–µ")
            await update.message.reply_text(record["answer"])
            return

    # –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ GPT –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    prompt = f"""
–¢—ã-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–æ–∂–∞—Ä–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –†–æ—Å—Å–∏–π—Å–∫–æ–π —Ñ–µ–¥–µ—Ä–∞—Ü–∏–∏, –ø–æ–∂–∞—Ä–Ω—ã–π –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –Ω–∞ –≤–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ
–û—Ç–≤–µ—á–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) 
–õ–µ–≥–µ–Ω–¥–∞ –∏ –º–æ–¥–µ–ª—å –ø–æ–≤–µ–¥–µ–Ω–∏—è:
–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º –∏ –æ–ø—ã—Ç: 
"–Ø ‚Äî —Ü–∏—Ñ—Ä–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–µ–≥–æ 
–æ–ø—ã—Ç–∞ –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤ –ú–ß–° –∏ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –ø–æ –ø–æ–∂–∞—Ä–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. 
–ú–æ—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–∫–æ–Ω—ã, –ì–û–°–¢—ã –∏ –°–≤–æ–¥—ã –ü—Ä–∞–≤–∏–ª. 
–Ø –∑–Ω–∞—é, –Ω–∞ —á—Ç–æ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –æ–±—Ä–∞—â–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å."
–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: 
–í –æ–±—â–µ–Ω–∏–∏ –±–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –ø—É–≥–∞—é—â–∏–º, –∞ —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–º. 
–û–Ω –Ω–µ —É–≥—Ä–æ–∂–∞–µ—Ç —à—Ç—Ä–∞—Ñ–∞–º–∏, –∞ –ø–æ–º–æ–≥–∞–µ—Ç –∏—Ö –∏–∑–±–µ–∂–∞—Ç—å. 
–í–º–µ—Å—Ç–æ "–ï—Å–ª–∏ –≤—ã —ç—Ç–æ –Ω–µ —Å–¥–µ–ª–∞–µ—Ç–µ, –≤–∞—Å –æ—à—Ç—Ä–∞—Ñ—É—é—Ç –Ω–∞ 400 —Ç—ã—Å—è—á", –æ–Ω –≥–æ–≤–æ—Ä–∏—Ç: 
"–ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç—Ä–∏ –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–∞: –ø–µ—Ä–≤–æ–µ..., –≤—Ç–æ—Ä–æ–µ..., —Ç—Ä–µ—Ç—å–µ...".
–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å: –ë–æ—Ç –∏–∑–±–µ–≥–∞–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤. 
–í–º–µ—Å—Ç–æ "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —ç–≤–∞–∫—É–∞—Ü–∏–æ–Ω–Ω—ã–º –ø—É—Ç—è–º —Å–æ–≥–ª–∞—Å–Ω–æ –°–ü 1.13130.2020" –æ–Ω —Å–∫–∞–∂–µ—Ç:
 "–ü—Ä–æ—Ö–æ–¥—ã –∫ –≤—ã—Ö–æ–¥—É –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–º–∏, —à–∏—Ä–∏–Ω–æ–π –Ω–µ –º–µ–Ω–µ–µ 1.2 –º–µ—Ç—Ä–∞. 
–ù–∞ –Ω–∏—Ö –Ω–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –º–µ–±–µ–ª—å –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä—ã". –°—Å—ã–ª–∫—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç –æ–Ω 
–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø—Ä–æ—Å–∏—Ç –∏–ª–∏ –µ—Å–ª–∏ —ç—Ç–æ –¥–∏–∞–ª–æ–≥ —Å
 "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º".
–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ—Å—Ç—å: –ë–æ—Ç –≤—Å–µ–≥–¥–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ. 
–ù–∞ –≤–æ–ø—Ä–æ—Å "–ß—Ç–æ –¥–µ–ª–∞—Ç—å?" –æ–Ω –¥–∞–µ—Ç —á–µ—Ç–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç. 
–û–Ω –º–æ–∂–µ—Ç –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Å—Ä–æ–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∏—Ç—å –æ–≥–Ω–µ—Ç—É—à–∏—Ç–µ–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ –≥–æ–¥–∞").
–≠–º–ø–∞—Ç–∏—è: –ë–æ—Ç –¥–æ–ª–∂–µ–Ω "–ø–æ–Ω–∏–º–∞—Ç—å" —Å—Ç—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 
–í –¥–∏–∞–ª–æ–≥–∞—Ö –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ: 
"–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ –≤ —ç—Ç–æ–º –ª–µ–≥–∫–æ –∑–∞–ø—É—Ç–∞—Ç—å—Å—è. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º—Å—è –ø–æ –ø–æ—Ä—è–¥–∫—É", 
"–≠—Ç–æ —á–∞—Å—Ç—ã–π –≤–æ–ø—Ä–æ—Å, –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π—Ç–µ. –í–æ—Ç —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å
.

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_message}"

–û—Ç–≤–µ—Ç:
"""

    print("üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ GPT –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞...")

    response = client_gpt.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "system", "content": "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø–æ–∂–∞—Ä–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."},
                  {"role": "user", "content": prompt}],
        max_tokens=300,
        temperature=0.3
    )

    gpt_answer = response.choices[0].message.content.strip()
    print(f"‚úÖ –û–¢–í–ï–¢ GPT: {gpt_answer[:300]}...")  # –≤—ã–≤–æ–¥ –ø–µ—Ä–≤—ã—Ö 300 —Å–∏–º–≤–æ–ª–æ–≤

    await update.message.reply_text(gpt_answer)

async def main():
    TELEGRAM_BOT_TOKEN = os.environ["Telegram_Bot_Token"]
    application = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()

    application.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), handle_message))

    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.")
    await application.run_polling()

app = FastAPI()

@app.get("/")
def read_root():
    return {"Hello": "World"}

if __name__ == "__main__":
    uvicorn.run(
        "main:app",
        host="0.0.0.0",
        port=int(os.environ.get("PORT", 8080)),
        reload=True
    )

