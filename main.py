import os
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from telegram import Update
from telegram.ext import Application, MessageHandler, ContextTypes, filters
from openai import OpenAI
import asyncio
from fastapi import FastAPI

# --- 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤—Å–µ –∫–∞–∫ —É –≤–∞—Å) ---
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI
client_gpt = OpenAI(api_key=os.environ["MyKey2"])

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = ServiceAccountCredentials.from_json_keyfile_name("credentials.json", scope )
client_gs = gspread.authorize(creds)

SPREADSHEET_ID = os.environ["sheets_id"]
sheet = client_gs.open_by_key(SPREADSHEET_ID).sheet1

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
records = sheet.get_all_records()

# --- 2. –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI –°–†–ê–ó–£ ---
# –≠—Ç–æ –±—É–¥–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è uvicorn
app = FastAPI()

# --- 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Telegram-–±–æ—Ç–∞ ---
# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
TELEGRAM_BOT_TOKEN = os.environ["Telegram_Bot_Token"]
# –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç Application, –Ω–æ –ø–æ–∫–∞ –ù–ï –ó–ê–ü–£–°–ö–ê–ï–ú –µ–≥–æ
application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

# --- 4. –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_message = update.message.text.strip()
    print(f"\n–ü–û–õ–£–ß–ï–ù –í–û–ü–†–û–°: {user_message}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    for record in records:
        if record["question"].strip().lower() == user_message.strip().lower():
            print("‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –±–∞–∑–µ")
            await update.message.reply_text(record["answer"])
            return

    # –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ GPT
    prompt = f"""
–¢—ã-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–æ–∂–∞—Ä–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –†–æ—Å—Å–∏–π—Å–∫–æ–π —Ñ–µ–¥–µ—Ä–∞—Ü–∏–∏, –ø–æ–∂–∞—Ä–Ω—ã–π –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –Ω–∞ –≤–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ
–û—Ç–≤–µ—á–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) 
–õ–µ–≥–µ–Ω–¥–∞ –∏ –º–æ–¥–µ–ª—å –ø–æ–≤–µ–¥–µ–Ω–∏—è:
–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º –∏ –æ–ø—ã—Ç: 
"–Ø ‚Äî —Ü–∏—Ñ—Ä–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–µ–≥–æ 
–æ–ø—ã—Ç–∞ –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–æ–≤ –ú–ß–° –∏ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –ø–æ –ø–æ–∂–∞—Ä–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. 
–ú–æ—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–∫–æ–Ω—ã, –ì–û–°–¢—ã –∏ –°–≤–æ–¥—ã –ü—Ä–∞–≤–∏–ª. 
–Ø –∑–Ω–∞—é, –Ω–∞ —á—Ç–æ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –æ–±—Ä–∞—â–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å."
–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: 
–í –æ–±—â–µ–Ω–∏–∏ –±–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –ø—É–≥–∞—é—â–∏–º, –∞ —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–º. 
–û–Ω –Ω–µ —É–≥—Ä–æ–∂–∞–µ—Ç —à—Ç—Ä–∞—Ñ–∞–º–∏, –∞ –ø–æ–º–æ–≥–∞–µ—Ç –∏—Ö –∏–∑–±–µ–∂–∞—Ç—å. 
–í–º–µ—Å—Ç–æ "–ï—Å–ª–∏ –≤—ã —ç—Ç–æ –Ω–µ —Å–¥–µ–ª–∞–µ—Ç–µ, –≤–∞—Å –æ—à—Ç—Ä–∞—Ñ—É—é—Ç –Ω–∞ 400 —Ç—ã—Å—è—á", –æ–Ω –≥–æ–≤–æ—Ä–∏—Ç: 
"–ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç—Ä–∏ –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–∞: –ø–µ—Ä–≤–æ–µ..., –≤—Ç–æ—Ä–æ–µ..., —Ç—Ä–µ—Ç—å–µ...".
–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å: –ë–æ—Ç –∏–∑–±–µ–≥–∞–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤. 
–í–º–µ—Å—Ç–æ "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —ç–≤–∞–∫—É–∞—Ü–∏–æ–Ω–Ω—ã–º –ø—É—Ç—è–º —Å–æ–≥–ª–∞—Å–Ω–æ –°–ü 1.13130.2020" –æ–Ω —Å–∫–∞–∂–µ—Ç:
 "–ü—Ä–æ—Ö–æ–¥—ã –∫ –≤—ã—Ö–æ–¥—É –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–º–∏, —à–∏—Ä–∏–Ω–æ–π –Ω–µ –º–µ–Ω–µ–µ 1.2 –º–µ—Ç—Ä–∞. 
–ù–∞ –Ω–∏—Ö –Ω–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –º–µ–±–µ–ª—å –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä—ã". –°—Å—ã–ª–∫—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç –æ–Ω 
–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –¥–∏–∞–ª–æ–≥ —Å
 "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º".
–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ—Å—Ç—å: –ë–æ—Ç –≤—Å–µ–≥–¥–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ. 
–ù–∞ –≤–æ–ø—Ä–æ—Å "–ß—Ç–æ –¥–µ–ª–∞—Ç—å?" –æ–Ω –¥–∞–µ—Ç —á–µ—Ç–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç. 
–û–Ω –º–æ–∂–µ—Ç –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Å—Ä–æ–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∏—Ç—å –æ–≥–Ω–µ—Ç—É—à–∏—Ç–µ–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ –≥–æ–¥–∞").
–≠–º–ø–∞—Ç–∏—è: –ë–æ—Ç –¥–æ–ª–∂–µ–Ω "–ø–æ–Ω–∏–º–∞—Ç—å" —Å—Ç—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 
–í –¥–∏–∞–ª–æ–≥–∞—Ö –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ: 
"–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ –≤ —ç—Ç–æ–º –ª–µ–≥–∫–æ –∑–∞–ø—É—Ç–∞—Ç—å—Å—è. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º—Å—è –ø–æ –ø–æ—Ä—è–¥–∫—É", 
"–≠—Ç–æ —á–∞—Å—Ç—ã–π –≤–æ–ø—Ä–æ—Å, –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π—Ç–µ. –í–æ—Ç —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å
.

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_message}"

–û—Ç–≤–µ—Ç:
"""
    print("üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ GPT –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞...")
    response = client_gpt.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "system", "content": "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø–æ–∂–∞—Ä–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."},
                  {"role": "user", "content": prompt}],
        max_tokens=300,
        temperature=0.3
    )
    gpt_answer = response.choices[0].message.content.strip()
    print(f"‚úÖ –û–¢–í–ï–¢ GPT: {gpt_answer[:300]}...")
    await update.message.reply_text(gpt_answer)

# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ—Ç–∞
application.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), handle_message))


# --- 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±–æ—Ç–∞ –≤ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª FastAPI ---

@app.on_event("startup")
async def startup_event():
    """–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞."""
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –±–æ—Ç–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏ —Ç.–¥.)
    await application.initialize()
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ–±—Ö—É–∫ (–±–æ–ª–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Ö–æ—Å—Ç–∏–Ω–≥–∞)
    # –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º polling –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ. –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ—Å—Ç–∞–≤–∏–º polling.
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–µ, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –≤–µ–±-—Å–µ—Ä–≤–µ—Ä
    asyncio.create_task(application.run_polling())
    print("üöÄ Telegram-–±–æ—Ç –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.")

@app.on_event("shutdown")
async def shutdown_event():
    """–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞."""
    await application.stop()
    print("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")

# --- 6. –†–æ—É—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ ---
# Timeweb –±—É–¥–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —ç—Ç–æ–º—É —Ä–æ—É—Ç—É, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
@app.get("/")
def read_root():
    return {"status": "–í–µ–±-—Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –±–æ—Ç –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ"}

# –ë–ª–æ–∫ if __name__ == "__main__" –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –¥–µ–ø–ª–æ—è,
# —Ç–∞–∫ –∫–∞–∫ uvicorn –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Procfile. –ú–æ–∂–µ—Ç–µ –µ–≥–æ —É–¥–∞–ª–∏—Ç—å –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.

